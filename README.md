# TfL Pi - Transport for London E-Paper Display

A Python project that displays real-time Transport for London (TfL) tube and bus departure information on an e-paper display, powered by a Raspberry Pi Zero 2W.

## Overview

This project transforms a Raspberry Pi Zero 2W and Waveshare 7.5-inch e-paper display into a beautiful, low-power departure board for London's public transport
network. Perfect for keeping track of your local tube and bus times at a glance.

## Hardware Requirements

- **Raspberry Pi Zero 2W**
- **Waveshare 7.5-inch e-Paper HAT**
    - Resolution: 800×480 pixels
    - Interface: SPI
    - Display color: Black/White
- microSD card (8GB or larger recommended)
- Power supply for Raspberry Pi (5V/2.5A recommended)

## Features

- Real-time tube departure information
- Real-time bus departure information
- Low power consumption thanks to e-paper display
- Automatic refresh intervals
- Clean, readable interface optimized for e-paper
- Uses official TfL Unified API

## Prerequisites

- Raspberry Pi OS (Raspbian) installed on your Pi Zero 2W
- Python 3.7 or higher
- TfL API key (free registration at [TfL API Portal](https://api.tfl.gov.uk/))
- Internet connection for fetching live data

## Installation

### Quick Setup (Recommended)

The easiest way to set up the project is using the automated setup script:

```bash
git clone https://github.com/taiyrbegeyev/tfl-pi.git
cd tfl-pi
./setup.sh
```

This will:
- Install system dependencies
- Create a Python virtual environment
- Install all Python packages
- Download the Waveshare e-paper driver
- Enable SPI interface
- Create your config.json

### Manual Installation

If you prefer to install manually:

#### 1. Enable SPI Interface

```bash
sudo raspi-config
# Navigate to: Interfacing Options -> SPI -> Enable
```

#### 2. Install System Dependencies

```bash
sudo apt-get update
sudo apt-get install python3-pip python3-venv python3-pil python3-numpy
sudo apt-get install libopenjp2-7 libtiff5
```

#### 3. Clone the Repository

```bash
git clone https://github.com/taiyrbegeyev/tfl-pi.git
cd tfl-pi
```

#### 4. Create Virtual Environment

```bash
python3 -m venv venv
source venv/bin/activate
```

#### 5. Install Python Dependencies

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

**Note:** Following [Waveshare's guide](https://www.waveshare.com/wiki/7.5inch_e-Paper_HAT_Manual#Question_about_Software), we use a virtual environment and regular `pip` (not `sudo pip`) to avoid permission issues.

#### 6. Generate systemd service file (optional)

If you want to run as a system service, generate the service file:

```bash
sed -e "s|__USER__|$(whoami)|g" -e "s|__INSTALL_DIR__|$(pwd)|g" tfl-display.service.template > tfl-display.service
```

## Configuration

1. Copy the example configuration file:

```bash
cp config.example.json config.json
```

2. Edit `config.json` with your settings:

```json
{
  "tfl_api_key": "YOUR_TFL_API_KEY",
  "stop_points": {
    "tube": [
      "STATION_ID"
    ],
    "bus": [
      "STOP_ID"
    ]
  },
  "refresh_interval": 60,
  "display_settings": {
    "width": 800,
    "height": 480
  }
}
```

### Finding Stop Point IDs

You can find stop point IDs using the TfL API:

- **Tube stations**: Use the [StopPoint API](https://api.tfl.gov.uk/StopPoint/Search/)
- **Bus stops**: Check bus stop signs for the 5-digit code or use TfL's journey planner

## Usage

### Run Once

First, activate the virtual environment, then run the application:

```bash
source venv/bin/activate
python3 main.py
```

Press `Ctrl+C` to stop the application.

### Run as a Service

To have the display update automatically on boot:

```bash
sudo cp tfl-display.service /etc/systemd/system/
sudo systemctl enable tfl-display.service
sudo systemctl start tfl-display.service
```

**Note:** The `tfl-display.service` file is automatically generated by `setup.sh` with your username and installation directory. If you moved the project or changed users, re-run `./setup.sh` to regenerate it with correct paths.

The systemd service automatically uses the virtual environment, so no need to activate it manually.

Check status:

```bash
sudo systemctl status tfl-display.service
```

View logs:

```bash
sudo journalctl -u tfl-display.service -f
```

## Project Structure

```
tfl-pi/
├── main.py              # Main application entry point
├── config.json          # Configuration file (create from example)
├── config.example.json  # Example configuration
├── requirements.txt     # Python dependencies
├── lib/                 # Libraries and modules
│   ├── tfl_api.py      # TfL API wrapper
│   ├── display.py      # E-paper display controller
│   └── renderer.py     # Display rendering logic
└── fonts/              # Custom fonts for display
```

## TfL API

This project uses the [TfL Unified API](https://api.tfl.gov.uk/). You'll need to register for a free API key:

1. Visit [TfL API Portal](https://api.tfl.gov.uk/)
2. Register for an account
3. Generate an API key
4. Add the key to your `config.json`

### API Rate Limits

- Free tier: 500 requests per minute
- This project is designed to stay well within these limits

## Troubleshooting

### Display not working

- Ensure SPI is enabled: `ls /dev/spi*` should show SPI devices
- Check ribbon cable connection between Pi and display
- Verify correct GPIO pins are connected
- Test display with Waveshare examples first

### Module import errors (e.g., "No module named 'spidev'")

- Make sure you activated the virtual environment: `source venv/bin/activate`
- Reinstall packages: `pip install -r requirements.txt`
- **Never use `sudo pip`** - this installs to system Python, not the venv
- For systemd service, regenerate the service file: `./setup.sh` (it auto-detects your username and paths)

### No data showing

- Verify TfL API key is correct in `config.json`
- Check internet connection: `ping api.tfl.gov.uk`
- Confirm stop point IDs are valid
- Run in mock mode first to test: set `"mock_mode": true` in config.json

### Display not refreshing

- Check service status: `sudo systemctl status tfl-display.service`
- View logs: `sudo journalctl -u tfl-display.service -f`
- If service fails to start, regenerate service file with `./setup.sh` and reinstall it

## Log Management

The application only logs warnings and errors to prevent filling up storage. Logs are managed by systemd's journal which has automatic rotation and retention policies.

### View Logs

```bash
# View recent logs
sudo journalctl -u tfl-display.service -n 50

# Follow logs in real-time
sudo journalctl -u tfl-display.service -f

# View logs from today
sudo journalctl -u tfl-display.service --since today
```

### Configure Log Retention (Optional)

To limit journal size, edit `/etc/systemd/journald.conf`:

```bash
sudo nano /etc/systemd/journald.conf
```

Add or modify these lines:

```ini
[Journal]
SystemMaxUse=100M        # Limit journal size to 100MB
MaxRetentionSec=7day     # Keep logs for 7 days
```

Then restart journald:

```bash
sudo systemctl restart systemd-journald
```

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## Helpful Resources

- [Waveshare 7.5" e-Paper HAT Manual](https://www.waveshare.com/wiki/7.5inch_e-Paper_HAT_Manual) - Official hardware documentation
- [TfL Unified API Documentation](https://api.tfl.gov.uk/) - Live transport data API
- [Waveshare e-Paper GitHub](https://github.com/waveshare/e-Paper) - Official driver library
- [Python Virtual Environments Guide](https://docs.python.org/3/tutorial/venv.html) - Official Python venv documentation

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Disclaimer

This is an unofficial project and is not affiliated with or endorsed by Transport for London.

---

Built with ❤️ for London commuters
